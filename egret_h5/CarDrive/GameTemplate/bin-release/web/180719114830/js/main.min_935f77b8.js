var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,r){return new(i||(i=Promise))(function(o,n){function a(t){try{h(r.next(t))}catch(e){n(e)}}function s(t){try{h(r["throw"](t))}catch(e){n(e)}}function h(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(a,s)}h((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return r([t,e])}}function r(i){if(o)throw new TypeError("Generator is already executing.");for(;h;)try{if(o=1,n&&(a=n[2&i[0]?"return":i[0]?"throw":"next"])&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[0,a.value]),i[0]){case 0:case 1:a=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,n=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(a=h.trys,!(a=a.length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){h.label=i[1];break}if(6===i[0]&&h.label<a[1]){h.label=a[1],a=i;break}if(a&&h.label<a[2]){h.label=a[2],h.ops.push(i);break}a[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(r){i=[6,r],n=0}finally{o=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,n,a,s,h={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},d5power;!function(t){var e=function(e){function i(t){var i=e.call(this,t)||this;return i._monitor=new egret.Bitmap,i}return __extends(i,e),i.prototype.run=function(t){this.updatePos()},i.prototype.updatePos=function(e,i){void 0===e&&(e=0),void 0===i&&(i=0);var r=this._pos.x,o=this._pos.y;if(this._map){var n=this._map.width>t.D5Game.screenWidth,a=this._map.height>t.D5Game.screenHeight;if(this.beFocus&&n&&a)r=t.D5Game.screenWidth>>1,o=t.D5Game.screenHeight>>1;else{var s=this._map.getScreenPostion(r,o);r=s.x,o=s.y}}null!=this._monitor&&(this._monitor.x=r+e,this._monitor.y=o+i)},i.prototype.setSkin=function(e){var i=t.D5UIResourceData.getData(e);if(null==i){trace("[D5Bitmap]No Resource"+e);var r=RES.getRes(e);return void(r?this.onResReady(r):RES.getResByUrl(e,this.onResReady,this,RES.ResourceItem.TYPE_IMAGE))}this.onResReady(i.getResource(0))},i.prototype.onResReady=function(t){this._monitor.texture=t,this._monitor.anchorOffsetX=Math.ceil(t.textureWidth>>1),this._monitor.anchorOffsetY=Math.ceil(t.textureHeight>>1)},i}(t.GameObject);t.SingleFrameCharacter=e,__reflect(e.prototype,"d5power.SingleFrameCharacter",["d5power.IGD"])}(d5power||(d5power={}));var Main=function(t){function e(){var i=t.call(this)||this;return e._me=i,i.addEventListener(egret.Event.ADDED_TO_STAGE,i.onAddToStage,i),i}return __extends(e,t),Object.defineProperty(e,"me",{get:function(){return this._me},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"game",{get:function(){return this._game},enumerable:!0,configurable:!0}),e.prototype.onAddToStage=function(t){d5power.D5UIResourceData.setup("resource/assets/ui/default/",this.onUIReady,this)},e.prototype.onUIReady=function(){this._game=new d5power.GameScene,this.addChild(this._game)},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var d5power;!function(t){var e=function(t){function e(e){var i=t.call(this)||this;return i.xspeed=0,i.yspeed=0,i.rotationSpeed=0,i.xscaleSpeed=0,i.yscaleSpeed=0,i.alphaSpeed=0,i.px=0,i.py=0,i.protation=0,i.palpha=1,i._lastRender=0,i._map=e,i}return __extends(e,t),e.getInstance=function(t){if(e._pool.length)return e._pool.pop();var i=new e(t);return i},e.back2Pool=function(t){-1==e._pool.indexOf(t)&&e._pool.push(t)},e.prototype.run=function(t){this.px+=this.xspeed,this.py+=this.yspeed,this.protation+=this.rotationSpeed,this.pscale+=this.xscaleSpeed,this.palpha+=this.alphaSpeed,t-this._lastRender>40&&(this._lastRender=t,this.scaleX=this.scaleY=this.pscale,this.alpha=this.palpha,this.rotation=this.protation);var e=this._map.getScreenPostion(this.px,this.py);this.x=e.x,this.y=e.y},e.prototype.isLife=function(t){return this.width*this.pscale<1||this.height*this.pscale<1||this.palpha<=0||this.life>0&&this.life<t?!1:!0},e.prototype.dispose=function(){this.scaleX=this.scaleY=1,this.rotation=0,this.xspeed=0,this.yspeed=0,this.xscaleSpeed=0,this.yscaleSpeed=0,this.rotationSpeed=0,this.alpha=1,this.px=0,this.py=0,this.protation=0,this.pscale=1,this.palpha=1,this.parent&&this.parent.removeChild(this),this.graphics.clear(),e.back2Pool(this)},e._pool=[],e}(egret.Shape);t.D5Particle=e,__reflect(e.prototype,"d5power.D5Particle",["d5power.ID5Particle"])}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function e(t,e){this._list=[],this._container=t,this._map=e}return e.prototype.bitmapRadiation=function(e,i,r,o,n){void 0===n&&(n=0);for(var a=egret.getTimer(),s=0;o>s;s++){var h=t.D5BitmapParticle.getInstance();h.texture=t.D5UIResourceData.getData(r).getResource(0),h.x=e,h.y=i,h.life=a+800;var p=2*Math.random()*3.1416;h.xspeed=16*Math.random()*Math.cos(p),h.yspeed=16*Math.random()*Math.sin(p),h.rotationSpeed=20*Math.random(),h.alphaSpeed=n,this._container.addChild(h),this._list.push(h)}},e.prototype.bitmapScale=function(e,i,r,o,n){void 0===n&&(n=0);for(var a=egret.getTimer(),s=0;o>s;s++){var h=t.D5BitmapParticle.getInstance();h.texture=t.D5UIResourceData.getData(r).getResource(0),h.x=e,h.y=i,h.life=a+800;var p=2*Math.random()*3.1416;h.xspeed=8*Math.random()*Math.cos(p),h.yspeed=8*Math.random()*Math.sin(p),h.xscaleSpeed=h.yscaleSpeed=.03*Math.random()*(Math.random()>.5?1:-1),h.alphaSpeed=n,this._container.addChild(h),this._list.push(h)}},e.prototype.graphicsScale=function(e,i,r,o,n,a,s){void 0===n&&(n=0),void 0===a&&(a=0),void 0===s&&(s=1);for(var h=egret.getTimer(),p=0;s>p;p++){var l=t.D5Particle.getInstance(this._map);l.graphics.beginFill(r,1),0==n?l.graphics.drawCircle(0,0,o*Math.random()+.5):(l.graphics.drawRect(0,0,o,o),l.anchorOffsetX=.5*o,l.anchorOffsetY=.5*o),l.graphics.endFill(),l.px=e,l.py=i,l.life=h+800;2*Math.random()*3.1416;l.xscaleSpeed=l.yscaleSpeed=-.03,l.alphaSpeed=a,this._container.addChild(l),this._list.push(l)}},e.prototype.graphicsRadiation=function(e,i,r,o,n){for(var a=egret.getTimer(),s=0;n>s;s++){var h=t.D5Particle.getInstance(this._map);h.graphics.beginFill(r,1),h.graphics.drawRect(.5*-o,.5*-o,o,o),h.graphics.endFill(),h.px=e,h.py=i,h.life=a+800;var p=2*Math.random()*3.1416;h.xspeed=16*Math.random()*Math.cos(p),h.yspeed=16*Math.random()*Math.sin(p),this._container.addChild(h),this._list.push(h)}},e.prototype.render=function(t){for(var e,i=this._list.length-1;i>=0;i--)e=this._list[i],e.run(t),e.isLife(t)||(e.dispose(),this._list.splice(i,1))},e.prototype.clear=function(){for(var t,e=this._list.length-1;e>=0;e--)t=this._list[e],t.dispose(),this._list.pop()},e}();t.D5ParticleCenter=e,__reflect(e.prototype,"d5power.D5ParticleCenter")}(d5power||(d5power={}));var d5power;!function(t){var e=function(e){function i(){var t=e.call(this)||this;return t._mapLayer=new egret.DisplayObjectContainer,t._carLayer=new egret.DisplayObjectContainer,t._effectLayer=new egret.DisplayObjectContainer,t.addChild(t._mapLayer),t.addChild(t._effectLayer),t.addChild(t._carLayer),t.once(egret.Event.ADDED_TO_STAGE,t.init,t),t}return __extends(i,e),Object.defineProperty(i.prototype,"particle",{get:function(){return this._particle},enumerable:!0,configurable:!0}),i.prototype.init=function(e){void 0===e&&(e=null),this._renderList=[],this._map=new t.UnlimitMap,this._map.setContainer(this._mapLayer),this._map.createLoop(1,"resource/map.png",this.onMapReady,this),this._mycar=new t.Car(this._map),this._carLayer.addChild(this._mycar.monitor),this._mycar.setPos(300,300),this._mycar.turnRoation=-90,this._mycar.engineOn(20),this._mycar.setSkin("resource/car0.png"),this._renderList.push(this._mycar);var i=new egret.Shape;i.graphics.beginFill(6710886),i.graphics.drawCircle(60,60,60),i.graphics.endFill();var r=new egret.Shape;r.graphics.beginFill(15658734),r.graphics.drawCircle(10,10,10),r.graphics.endFill(),this.addChild(i),this._particle=new t.D5ParticleCenter(this._effectLayer,this._map);var o=new t.TouchController(this.stage,this.onController,this);o.init(i,r)},i.prototype.onController=function(t,e,i){return void 0===t&&(t=0/0),void 0===e&&(e=0/0),void 0===i&&(i=0/0),isNaN(t)&&isNaN(e)?void this._mycar.engineOff():(this._mycar.turnRoation=Math.ceil(180*t/Math.PI),void this._mycar.engineOn(20))},i.prototype.onMapReady=function(){this._camera=new t.UnlimitCamera(this._map),this._camera.focus=this._mycar,this.addEventListener(egret.Event.ENTER_FRAME,this.render,this)},i.prototype.render=function(t){var e=egret.getTimer();this._map.render();for(var i=this._renderList.length-1;i>=0;i--)this._renderList[i].run(e),this._renderList[i].render(e);this._camera.update(),this._particle.render(e)},i}(egret.DisplayObjectContainer);t.GameScene=e,__reflect(e.prototype,"d5power.GameScene")}(d5power||(d5power={}));var d5power;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.xspeed=0,e.yspeed=0,e.rotationSpeed=0,e.xscaleSpeed=0,e.yscaleSpeed=0,e.alphaSpeed=0,e}return __extends(e,t),e.getInstance=function(){if(e._pool.length)return e._pool.pop();var t=new e;return t},e.back2Pool=function(t){-1==e._pool.indexOf(t)&&e._pool.push(t)},e.prototype.run=function(){this.x+=this.xspeed,this.y+=this.yspeed,this.rotation+=this.rotationSpeed,this.scaleX+=this.xscaleSpeed,this.scaleY+=this.yscaleSpeed,this.alpha+=this.alphaSpeed},e.prototype.isLife=function(t){return this.alpha<=0||this.life>0&&this.life<t?!1:!0},e.prototype.dispose=function(){this.scaleX=this.scaleY=1,this.rotation=0,this.xspeed=0,this.yspeed=0,this.xscaleSpeed=0,this.yscaleSpeed=0,this.rotationSpeed=0,this.alphaSpeed=1,this.alpha=1,this.parent&&this.parent.removeChild(this),e.back2Pool(this)},e._pool=[],e}(egret.Bitmap);t.D5BitmapParticle=e,__reflect(e.prototype,"d5power.D5BitmapParticle")}(d5power||(d5power={}));var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var d5power;!function(t){var e=function(t){function e(e){var i=t.call(this,e)||this;return i._turnRoation=0,i._speed=0,i._powerOn=!1,i._friction=1,i._rotationSpeed=2,i._targetTurnRotaion=0,i._targetTurnDir=1,i._lastParticle=0,i}return __extends(e,t),e.prototype.engineOn=function(t){this._speed=t,this._powerOn=!0},e.prototype.engineOff=function(){this._powerOn=!1},Object.defineProperty(e.prototype,"turnRoation",{get:function(){return this._turnRoation},set:function(t){Math.abs(this._turnRoation-t)>180&&(this._turnRoation+=t>0?360:-360),this._targetTurnRotaion=t,this._targetTurnDir=t>this._turnRoation?1:-1},enumerable:!0,configurable:!0}),e.prototype.run=function(i){this._targetTurnRotaion!=this._turnRoation&&(this._turnRoation=Math.abs(this._turnRoation-this._targetTurnRotaion)>this._rotationSpeed?this._turnRoation+this._targetTurnDir*this._rotationSpeed:this._targetTurnRotaion),this._monitor.rotation=this._turnRoation;var r=this._speed*Math.cos(this._turnRoation*e.PI_180),o=this._speed*Math.sin(this._turnRoation*e.PI_180);if(this._pos.x+=r,this._pos.y+=o,this._powerOn||(this._speed=this._speed*this._friction),t.prototype.run.call(this,i),i-this._lastParticle>40){this._lastParticle=i;for(var n=0,a=this._particlePoints.length;a>n;n++){var s=this._monitor.localToGlobal(this._particlePoints[n].x,this._particlePoints[n].y);s=this._map.getWorldPostion(s.x,s.y),Main.me.game.particle.graphicsScale(s.x,s.y,16777215,20,1,-.05)}}},e.prototype.onResReady=function(e){t.prototype.onResReady.call(this,e);var i=new egret.Point(.2*e.textureWidth,.1*e.textureHeight),r=new egret.Point(.2*e.textureWidth,.9*e.textureHeight);this._particlePoints=[i,r]},e.maxLunRota=45,e.PI_180=Math.PI/180,e.l80_PI=180/Math.PI,e}(t.SingleFrameCharacter);t.Car=e,__reflect(e.prototype,"d5power.Car")}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function t(t,e,i){this._callback=e,this._thisobj=i,this._listener=t,this._listener.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onBegin,this)}return t.prototype.init=function(t,e){return t.width&&t.height&&e.width&&e.height?(t.parent||egret.error("[TouchController] please make true bg is in stage."),this._bg=t,this._controller=e,this._stage=this._bg.stage,this._bg.parent.removeChild(this._bg),this._limit=t.width>t.height?Math.ceil(t.width>>1):Math.ceil(t.height>>1),this._bg.anchorOffsetX=this._bg.width>>1,this._bg.anchorOffsetY=this._bg.height>>1,this._controller.anchorOffsetX=this._controller.width>>1,this._controller.anchorOffsetY=this._controller.height>>1,this._bg.touchEnabled=!1,void(this._controller.touchEnabled=!1)):void egret.error("[TouchController] please draw ui interface first.")},t.prototype.onBegin=function(t){this._listener.once(egret.TouchEvent.TOUCH_END,this.onEnd,this),this._listener.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onMove,this),this._bg.x=this._controller.x=t.stageX,this._bg.y=this._controller.y=t.stageY,this._lastX=this._bg.x,this._lastY=this._bg.y,this._stage.addChild(this._bg),this._stage.addChild(this._controller)},t.prototype.onMove=function(t){t.updateAfterEvent();var e=t.stageX-this._bg.x,i=t.stageY-this._bg.y,r=Math.sqrt(e*e+i*i),o=Math.atan2(t.stageY-this._bg.y,t.stageX-this._bg.x),n=Math.atan2(t.stageY-this._lastY,t.stageX-this._lastX);r>this._limit?(this._controller.x=this._bg.x+parseInt(this._limit*Math.cos(o)+""),this._controller.y=this._bg.y+parseInt(this._limit*Math.sin(o)+"")):(this._controller.x=t.stageX,this._controller.y=t.stageY),null!=this._callback&&this._callback.apply(this._thisobj,[o,r,n])},t.prototype.onEnd=function(t){this._listener.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onMove,this),this._bg&&this._bg.parent&&this._bg.parent.removeChild(this._bg),this._controller&&this._controller.parent&&this._controller.parent.removeChild(this._controller),this._callback&&this._callback.apply(this._thisobj)},t}();t.TouchController=e,__reflect(e.prototype,"d5power.TouchController")}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function e(t){this._zorderSpeed=600,this._moveSpeed=1,this._moveAngle=0,null==e._cameraView&&(e._cameraView=new egret.Rectangle),this._cameraCutView=new egret.Rectangle,this._map=t}return Object.defineProperty(e,"needreCut",{get:function(){return e.$needreCut},enumerable:!0,configurable:!0}),e.prototype.setZero=function(i,r){i=Math.ceil(i),r=Math.ceil(r),e.zeroX=i,e.zeroY=r;var o=this._map.width-t.D5Game.screenWidth;o=this._map.height-t.D5Game.screenHeight},e.prototype.update=function(){this._focus&&this.setZero(this._focus.posX-(t.D5Game.screenWidth>>1),this._focus.posY-(t.D5Game.screenHeight>>1)),e._cameraView.x=e.zeroX,e._cameraView.y=e.zeroY,e._cameraView.width=t.D5Game.screenWidth,e._cameraView.height=t.D5Game.screenHeight},Object.defineProperty(e.prototype,"focus",{get:function(){return this._focus},set:function(t){this._focus&&(this._focus.beFocus=!1),this._focus=t,t.beFocus=!0,this.update(),this.reCut()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"moveSpeed",{set:function(t){this._moveSpeed=t},enumerable:!0,configurable:!0}),Object.defineProperty(e,"cameraView",{get:function(){return e._cameraView},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cameraCutView",{get:function(){var i=e.zeroX,r=e.zeroY;return i>0&&(i-=2*this._map.tileWidth),i>0&&(r-=r-2*this._map.tileHeight),i=0>i?0:i,r=0>r?0:r,this._cameraCutView.x=i,this._cameraCutView.y=r,this._cameraCutView.width=t.D5Game.screenWidth+2*this._map.tileWidth,this._cameraCutView.height=t.D5Game.screenHeight+2*this._map.tileHeight,this._cameraCutView},enumerable:!0,configurable:!0}),e.prototype.moveNorth=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&0!=e.zeroY&&(this.focus=null,this.setZero(e.zeroX,e.zeroY-this._moveSpeed*t),this.reCut())},e.prototype.moveSourth=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&(this.focus=null,this.setZero(e.zeroX,e.zeroY+this._moveSpeed*t),this.reCut())},e.prototype.moveWest=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&0!=e.zeroX&&(this.focus=null,this.setZero(e.zeroX-this._moveSpeed*t,e.zeroY),this.reCut())},e.prototype.moveEast=function(t){void 0===t&&(t=1),0!=this._moveSpeed&&(this.focus=null,this.setZero(e.zeroX+this._moveSpeed*t,e.zeroY),this.reCut())},e.prototype.move=function(t,i,r){void 0===r&&(r=1),this.focus=null,this.setZero(e.zeroX+this._moveSpeed*t*r,e.zeroY+this._moveSpeed*i*r),this.reCut()},e.prototype.lookAt=function(e,i){this.focus=null,this.setZero(e-(t.D5Game.screenWidth>>1),i-(t.D5Game.screenHeight>>1)),this.reCut()},e.prototype.flyTo=function(i,r,o){return void 0===o&&(o=null),null!=this._timer?void console.log("[D5Camera] Camera is moving,can not do this operation."):(this.focus=null,this._moveCallBack=o,this._moveStart=new egret.Point(e.zeroX-(t.D5Game.screenWidth>>1),e.zeroY-(t.D5Game.screenHeight>>1)),this._moveEnd=new egret.Point(i-(t.D5Game.screenWidth>>1),r-(t.D5Game.screenHeight>>1)),this._timer=new egret.Timer(50),this._timer.addEventListener(egret.TimerEvent.TIMER,this.moveCamera,this),void this._timer.start())},e.prototype.moveCamera=function(t){var e=8,i=(this._moveEnd.x-this._moveStart.x)/e,r=(this._moveEnd.y-this._moveStart.y)/e;this._moveStart.x+=i,this._moveStart.y+=r,this.setZero(this._moveStart.x,this._moveStart.y),i>-.2&&.2>i&&r>-.2&&.2>r&&(this._moveEnd=null,this._timer.stop(),this._timer.removeEventListener(egret.TimerEvent.TIMER,this.moveCamera,this),this._timer=null,this.reCut(),null!=this._moveCallBack&&this._moveCallBack())},Object.defineProperty(e.prototype,"zorderSpeed",{get:function(){return this._zorderSpeed},enumerable:!0,configurable:!0}),e.prototype.reCut=function(){},e.zeroX=0,e.zeroY=0,e.RenderMaxTime=10,e}();t.UnlimitCamera=e,__reflect(e.prototype,"d5power.UnlimitCamera")}(d5power||(d5power={}));var d5power;!function(t){var e=function(){function e(t){void 0===t&&(t=null),this._tileFormat=".jpg",this._roadW=60,this._roadH=30,this._nowStartX=-1,this._nowStartY=-1,this._tempPoint=new egret.Point,this._gameObjectManager=t}return e.rebuildPool=function(t){if(e._tilePool.length>t)for(;e._tilePool.length>t;)e._tilePool.pop();else for(;e._tilePool.length<t;)e._tilePool.push(new egret.Bitmap)},e.back2pool=function(t){-1==e._tilePool.indexOf(t)&&e._tilePool.push(t)},e.getTile=function(){var t;return t=e._tilePool.length?e._tilePool.pop():new egret.Bitmap,t.texture=null,t},e.prototype.createLoop=function(t,e,i,r,o,n){void 0===o&&(o=10),void 0===n&&(n=10);var a=this;RES.getResByUrl(e,function(e){a._mapid=t,a._tileW=e.textureWidth,a._tileH=e.textureHeight,a._mapHeight=this._tileH*n,a._mapWidth=this._tileW*o,a._onReady=i,a._onReadyThis=r,a._nowStartX=-1,a._nowStartY=-1,a._loopBg=e,a.setupRoad(null),a._dbuffer&&(a._dbuffer.texture=e,a._dbuffer.width=a._mapWidth,a._dbuffer.height=a._mapHeight,a._dbuffer.anchorOffsetX=a._tileW,a._dbuffer.anchorOffsetY=a._tileH)},this)},e.prototype.enter=function(e,i,r){var o=this;RES.getResByUrl(t.D5Game.RES_SERVER+t.D5Game.ASSET_PATH+"/tiles/"+e+"/mapconf.json",function(t){o._data=t,o.setup(parseInt(t.id),parseInt(t.mapW),parseInt(t.mapH),parseInt(t.tileX),parseInt(t.tileY),i,r)},this)},Object.defineProperty(e.prototype,"id",{get:function(){return this._mapid},enumerable:!0,configurable:!0}),e.prototype.setContainer=function(e){if(!e.contains(this._dbuffer))if(null!=this._dbuffer?this._dbuffer.parent&&this._dbuffer.parent.removeChild(this._dbuffer):(this._dbuffer=new egret.Bitmap,this._dbuffer.fillMode=egret.BitmapFillMode.REPEAT,this._loopBg&&(this._dbuffer.texture=this._loopBg),this._dbuffer.width=this._mapWidth,this._dbuffer.height=this._mapHeight),e.addChild(this._dbuffer),null==this._dbuffer.stage){var i=this;this._dbuffer.once(egret.Event.ADDED_TO_STAGE,function(){t.D5Game.screenWidth=i._dbuffer.stage.stageWidth,t.D5Game.screenHeight=i._dbuffer.stage.stageHeight},this)}else t.D5Game.screenWidth=this._dbuffer.stage.stageWidth,t.D5Game.screenHeight=this._dbuffer.stage.stageHeight},e.prototype.setTileFormat=function(t){"."!=t.substr(0,1)&&(t="."+t),this._tileFormat=t},e.prototype.setup=function(e,i,r,o,n,a,s){this._mapid=e,this._mapHeight=r,this._mapWidth=i,this._tileW=o,this._tileH=n,this._onReady=a,this._onReadyThis=s,this._nowStartX=-1,this._nowStartY=-1;var h=this,p=function(e){h._smallMap=new egret.SpriteSheet(e),h.createSmallData(e.textureWidth,e.textureHeight),RES.getResByUrl(t.D5Game.RES_SERVER+t.D5Game.ASSET_PATH+"/tiles/"+h._mapid+"/roadmap.bin",h.setupRoad,h,RES.ResourceItem.TYPE_BIN)};RES.getResByUrl(t.D5Game.RES_SERVER+t.D5Game.ASSET_PATH+"/tiles/"+this._mapid+"/s.jpg",p,this)},e.prototype.createSmallData=function(t,e){var i,r,o=t/(this._mapWidth/this._tileW),n=e/(this._mapHeight/this._tileH);for(r=0;r<this._mapWidth/this._tileW;r++)for(i=0;i<this._mapHeight/this._tileH;i++)this._smallMap.createTexture("small"+r+"_"+i,i*o,r*n,o,n,0,0)},Object.defineProperty(e.prototype,"width",{get:function(){return this._mapWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._mapHeight},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tileWidth",{get:function(){return this._tileW},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tileHeight",{get:function(){return this._tileH},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"roadWidth",{get:function(){return this._roadW},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"roadHeight",{get:function(){return this._roadH},enumerable:!0,configurable:!0}),e.prototype.render=function(e){void 0===e&&(e=!1);var i=t.UnlimitCamera.zeroX%this._tileW,r=t.UnlimitCamera.zeroY%this._tileH;this._dbuffer.x=-i,this._dbuffer.y=-r},e.prototype.resize=function(){this._areaX=Math.ceil(t.D5Game.screenWidth/this._tileW)+1,this._areaY=Math.ceil(t.D5Game.screenHeight/this._tileH)+1,console.log("[D5Game] max tiles number ",this._areaX,this._areaY),e.rebuildPool(this._areaX*this._areaY+this._areaX+this._areaY)},e.prototype.resetRoad=function(){this._roadArr=[],this._alphaArr=[];for(var t=Math.floor(this._mapHeight/this._roadH),e=Math.floor(this._mapWidth/this._roadW),i=0;t>i;i++){for(var r=new Array,o=new Array,n=0;e>n;n++)r.push(0),o.push(0);this._roadArr.push(r),this._alphaArr.push(o)}},e.prototype.setRoad=function(t){this._roadArr=t},e.prototype.isInAlphaArea=function(t,i){var r=this.Postion2Tile(t,i);return this._alphaArr[r.y]&&this._alphaArr[r.y][r.x]==e.BIN_ALPHA_VALUE},e.prototype.getPointAround=function(e,i,r){if(!e||!i)return null;for(var o=0,n=5,a=2*Math.PI/n,s=new egret.Point,h=t.GMath.getPointAngle(e.x-i.x,e.y-i.y)+(Math.random()>.5?1:-1)*Math.PI/8;n>o;){var p=a*o+h;if(s.x=Math.round(e.x-r*Math.cos(p)),s.y=Math.round(e.y-r*Math.sin(p)),this.PointCanMove(s,i))return s;o++}return null},e.prototype.PointCanMove=function(t,e){if(null==this._astar)return!0;var i=this._astar.find(e.x,e.y,t.x,t.y);return null!=i},e.prototype.getRoadPass=function(t,e){return null==this._roadArr[e]||0!=this._roadArr[e][t]?!1:!0},e.prototype.findPath=function(t,e,i,r){return null==this._astar?null:this._astar.find(t,e,i,r)},e.prototype.getWorldPostion=function(e,i){return this._tempPoint.x=t.UnlimitCamera.zeroX+e,this._tempPoint.y=t.UnlimitCamera.zeroY+i,this._tempPoint},e.prototype.getScreenPostion=function(e,i){return this._tempPoint.x=e-t.UnlimitCamera.zeroX,this._tempPoint.y=i-t.UnlimitCamera.zeroY,this._tempPoint},e.prototype.tile2WorldPostion=function(t,e){return this._tempPoint.x=t*this._roadW+.5*this._roadW,this._tempPoint.y=e*this._roadH+.5*this._roadH,this._tempPoint},e.prototype.Postion2Tile=function(t,e){return this._tempPoint.x=Math.floor(t/this._roadW),this._tempPoint.y=Math.floor(e/this._roadH),this._tempPoint},e.prototype.reset=function(){this._tempPoint=new egret.Point,this._mapResource={tiles:new Object}},e.prototype.setupRoad=function(i){if(null==i||void 0==i)this.resetRoad();else{var r,o=new egret.ByteArray(i),n=o.readUTFBytes(5),a=0,s=0;if("D5Map"==n){s=o.readShort(),a=o.readShort();for(var h=[],p=0;s>p;p++){for(var l=[],_=0;a>_;_++)l.push(o.readByte());h.push(l)}if(this.resetRoad(),a>1){var c=Math.floor(this._mapHeight/this._roadH),u=Math.floor(this._mapWidth/this._roadW),d=u==a&&c==s?1:s/c;for(p=0;c>p;p++)for(_=0;u>_;_++)try{s=Math.floor(p*d),a=Math.floor(_*d),r=h[s][a],this._roadArr[p][_]=r==e.BIN_NO_VALUE?1:0,this._alphaArr[p][_]=r}catch(f){trace("［UnlimitMap］路点超出范围Y:X("+p+":"+_+")",s,a),this._roadArr[p][_]=e.BIN_NO_VALUE,this._alphaArr[p][_]=e.BIN_NO_VALUE}}}else console.log("[UnlimitMap]非法的地图配置文件")}this.reset(),this.resize(),this._astar=new t.SilzAstar(this._roadArr);var m=this._data&&this._data.npc?this._data.npc.length:0;if(null!=this._gameObjectManager)for(var g=0;m>g;g++){var y=new t.NPConf;y.format(this._data.npc[g]),this._gameObjectManager.addNPC(y)}null!=this._onReady&&this._onReady.apply(this._onReadyThis)},e.BIN_ALPHA_VALUE=2,e.BIN_CAN_VALUE=1,e.BIN_NO_VALUE=0,e._tilePool=new Array,e}();t.UnlimitMap=e,__reflect(e.prototype,"d5power.UnlimitMap",["d5power.IMap"])}(d5power||(d5power={}));